<div class="cyber-panel">
    <h1 style="text-align:center;margin-bottom:0.8rem;">ğŸ“¦ å¤–é€è³‡ç”¢è¨‚è³¼å–®</h1>
    <div id="date-picker">
        <label style="color:var(--neon-cyan);margin-right:5px;">é¸æ“‡æ—¥æœŸï¼š</label>
        <span id="date-display"></span>
        <button id="reset-date-button">ä»Šå¤©</button>
        <div id="date-modal">
            <select id="year-select"></select>
            <select id="month-select"></select>
            <select id="day-select"></select>
        </div>
    </div>

    <div class="category-section">
        <div class="category-title">UberEats</div>
        <div class="grid-container" data-category="ubereats">
            <div class="cyber-input"><span class="label">UberEatsæè¢‹</span><input type="text" name="ubereats_bag" value=""></div>
            <div class="cyber-input"><span class="label">UberEatså…­æ ¼ç®±</span><input type="text" name="ubereats_6grid" value=""></div>
            <div class="cyber-input"><span class="label">UberEatså…«æ ¼ç®±</span><input type="text" name="ubereats_8grid" value=""></div>
        </div>
    </div>

    <div class="category-section">
        <div class="category-title">FoodPanda</div>
        <div class="grid-container" data-category="foodpanda">
            <div class="cyber-input"><span class="label">FoodPandaæè¢‹</span><input type="text" name="foodpanda_bag" value=""></div>
            <div class="cyber-input"><span class="label">FoodPandaå…­æ ¼ç®±</span><input type="text" name="foodpanda_6grid" value=""></div>
            <div class="cyber-input"><span class="label">FoodPandaå…«æ ¼ç®±</span><input type="text" name="foodpanda_8grid" value=""></div>
            <div class="cyber-input"><span class="label">FoodPanda 2022å…­æ ¼ç®±</span><input type="text" name="foodpanda_2022_6grid" value=""></div>
            <div class="cyber-input"><span class="label">FoodPanda 2022å…«æ ¼ç®±</span><input type="text" name="foodpanda_2022_8grid" value=""></div>
            <div class="cyber-input"><span class="label">FoodPandaé­”é¬¼æ°ˆä¿æº«ç®±</span><input type="text" name="foodpanda_velcro_insulated" value=""></div>
            <div class="cyber-input"><span class="label">FoodPandaç£å¸å¼ä¿æº«ç®±</span><input type="text" name="foodpanda_magnetic_insulated" value=""></div>
            <div class="cyber-input"><span class="label">FoodPandaä¸Šæ€æ¬¾ä¿æº«ç®±</span><input type="text" name="foodpanda_flip_insulated" value=""></div>
        </div>
    </div>

    <!-- æ¡è³¼è¨ˆç®— -->
    <div class="category-section">
        <div class="category-title">æ¡è³¼è¨ˆç®—</div>
        <div id="hud-display"></div>
    </div>

    <!-- æ¡è³¼æˆæœ¬æ¡†æ¶ -->
    <div class="category-section">
        <div class="category-title">æ¡è³¼æˆæœ¬</div>
        <div id="cost-display" class="no-copy"></div>
        <div id="cost-summary" class="cost-summary no-copy">
            <div class="cost-total-row">
                <span class="cost-total">ç¸½æˆæœ¬: <span id="total-cost-amount">0</span> å…ƒ</span>
                <input type="text" id="cost-note-input" class="cost-note-input">
            </div>
        </div>
    </div>
</div>

<style>
    :root {
        --space-blue: #1a1a2e;
        --neon-cyan: #00f3ff;
        --cyber-purple: #712f79;
        --transition-time: 0.3s;
    }
    body {
        background: var(--space-blue);
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            linear-gradient(45deg, rgba(0,243,255,0.1) 1px, transparent 1px),
            linear-gradient(-45deg, rgba(0,243,255,0.1) 1px, transparent 1px);
        background-size: 40px 40px;
        z-index: -1;
        animation: gridMove 20s linear infinite;
    }
    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at center, transparent 0%, var(--space-blue) 100%);
        z-index: -1;
    }
    @keyframes gridMove {
        0% {
            background-position: 0 0;
        }
        100% {
            background-position: 40px 40px;
        }
    }
    .cyber-panel {
        background: var(--space-blue);
        color: var(--neon-cyan);
        border: 1px solid var(--neon-cyan);
        border-radius: 8px;
        padding: 0.5rem;
        width: 100%;
        max-width: 360px;
        box-shadow: 0 0 15px rgba(0,243,255,0.2);
        box-sizing: border-box;
        margin: 0 auto;
    }
    .grid-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.5rem;
        padding: 0.5rem 0;
    }
    .category-section {
        margin-bottom: 0.8rem;
    }
    .category-title {
        color: var(--neon-cyan);
        font-size: 1.2rem;
        margin-bottom: 0.4rem;
        border-bottom: 1px solid var(--cyber-purple);
        padding-bottom: 0.2rem;
    }
    .cyber-input {
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--cyber-purple);
        border-radius: 6px;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all var(--transition-time) cubic-bezier(0.4, 0, 0.2, 1);
    }
    .cyber-input .label {
        text-align: left;
    }
    .cyber-input:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 10px rgba(113,47,121,0.4);
    }
    input[type="text"] {
        width: 80px;
        padding: 0.5rem;
        background: transparent;
        border: 1px solid var(--neon-cyan);
        border-radius: 4px;
        color: var(--neon-cyan);
        font-size: 1rem;
        text-align: center;
        transition: border-color var(--transition-time);
    }
    input[type="text"]:focus {
        border-color: var(--cyber-purple);
        outline: none;
    }
    #hud-display, #cost-display {
        background: rgba(0,0,0,0.5);
        border: 1px solid var(--neon-cyan);
        border-radius: 6px;
        padding: 0.8rem;
        margin-top: 0.8rem;
        text-align: left;
        backdrop-filter: blur(8px);
        transition: border-color var(--transition-time);
    }
    #hud-display {
        cursor: pointer;
    }
    #hud-display:hover {
        border-color: var(--cyber-purple);
    }
    .no-copy {
        cursor: default;
    }
    #hud-display p, #cost-display p {
        margin: 3px 0;
        font-size: 1rem;
        color: var(--neon-cyan);
    }
    .cost-summary {
        background: rgba(0,0,0,0.5);
        border: 1px solid var(--neon-cyan);
        border-radius: 6px;
        padding: 0.8rem;
        margin-top: 0.8rem;
        backdrop-filter: blur(8px);
        transition: border-color var(--transition-time);
        display: none; /* é»˜èªéš±è—ï¼Œæœ‰æˆæœ¬æ™‚é¡¯ç¤º */
    }
    .cost-total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .cost-total {
        font-weight: bold;
        color: var(--neon-cyan);
        font-size: 1.1rem;
    }
    .cost-note-input {
        width: 80px;
        padding: 0.4rem;
        background: rgba(0,0,0,0.3);
        border: 1px solid var(--neon-cyan);
        border-radius: 4px;
        color: var(--neon-cyan);
        font-size: 0.9rem;
        text-align: center;
        transition: all var(--transition-time);
    }
    .cost-note-input:focus {
        border-color: var(--cyber-purple);
        outline: none;
    }
    #date-picker {
        text-align: center;
        margin-bottom: 0.4rem;
        position: relative;
    }
    #date-display {
        background: transparent;
        border: 1px solid var(--neon-cyan);
        color: var(--neon-cyan);
        padding: 0.3rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        display: inline-block;
        margin-left: 5px;
        transition: box-shadow var(--transition-time);
    }
    #date-display:hover {
        box-shadow: 0 0 8px rgba(0,243,255,0.5);
    }
    #date-modal {
        display: none;
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        border: 1px solid var(--neon-cyan);
        border-radius: 6px;
        padding: 0.5rem;
        z-index: 10;
        box-shadow: 0 0 15px rgba(0,243,255,0.3);
    }
    #date-modal select {
        background: var(--space-blue);
        border: 1px solid var(--cyber-purple);
        color: var(--neon-cyan);
        padding: 0.3rem;
        margin: 0.3rem;
        border-radius: 4px;
        font-size: 0.9rem;
    }
    #reset-date-button {
        margin-left: 5px;
        padding: 3px 8px;
        background: var(--cyber-purple);
        border: 1px solid var(--neon-cyan);
        border-radius: 4px;
        color: var(--neon-cyan);
        cursor: pointer;
        transition: all var(--transition-time);
    }
    #reset-date-button:hover {
        background: var(--neon-cyan);
        color: var(--space-blue);
    }
    @media (max-width: 480px) {
        .cyber-panel {
            padding: 0.4rem;
            max-width: 100%;
        }
        .category-title {
            font-size: 1.1rem;
        }
        .cyber-input {
            padding: 0.4rem;
        }
        input[type="text"] {
            width: 70px;
            font-size: 0.9rem;
        }
        #hud-display, #cost-display {
            padding: 0.6rem;
        }
    }
</style>

<script>
    const utils = {
        padZero(num) { return String(num).padStart(2, '0'); },
        getDaysInMonth(year, month) { return new Date(year, month, 0).getDate(); },
        formatNumber(num) { return num.toLocaleString(); }
    };

    const dateManager = {
        state: { year: 2025, month: new Date().getMonth() + 1, day: new Date().getDate() },
        elements: {
            display: document.getElementById('date-display'),
            modal: document.getElementById('date-modal'),
            yearSelect: document.getElementById('year-select'),
            monthSelect: document.getElementById('month-select'),
            daySelect: document.getElementById('day-select')
        },
        init() {
            this.render();
            this.bindEvents();
        },
        render() {
            this.elements.display.textContent = 
                `${this.state.year}/${utils.padZero(this.state.month)}/${utils.padZero(this.state.day)}`;
            this.populateYears();
            this.populateMonths();
            this.populateDays();
            calculateResult();
        },
        populateYears() {
            this.elements.yearSelect.innerHTML = '';
            for (let year = 2025; year <= 2054; year++) {
                this.elements.yearSelect.add(new Option(year, year, year === this.state.year));
            }
        },
        populateMonths() {
            this.elements.monthSelect.innerHTML = '';
            for (let month = 1; month <= 12; month++) {
                this.elements.monthSelect.add(new Option(utils.padZero(month), month, month === this.state.month));
            }
        },
        populateDays() {
            this.elements.daySelect.innerHTML = '';
            const days = utils.getDaysInMonth(this.state.year, this.state.month);
            for (let day = 1; day <= days; day++) {
                this.elements.daySelect.add(new Option(utils.padZero(day), day, day === this.state.day));
            }
        },
        resetToToday() {
            const today = new Date();
            this.state.year = today.getFullYear() < 2025 ? 2025 : today.getFullYear();
            this.state.month = today.getMonth() + 1;
            this.state.day = today.getDate();
            this.render();
        },
        bindEvents() {
            this.elements.display.addEventListener('click', () => {
                this.elements.modal.style.display = 'block';
                calculateResult();
            });
            document.getElementById('reset-date-button').addEventListener('click', () => this.resetToToday());
            this.elements.yearSelect.addEventListener('change', (e) => {
                this.state.year = parseInt(e.target.value);
                this.render();
            });
            this.elements.monthSelect.addEventListener('change', (e) => {
                this.state.month = parseInt(e.target.value);
                this.render();
            });
            this.elements.daySelect.addEventListener('change', (e) => {
                this.state.day = parseInt(e.target.value);
                this.elements.modal.style.display = 'none';
                this.render();
            });
        }
    };

    const inputManager = {
        inputs: Array.from(document.querySelectorAll('input[type="text"]')),
        previousValues: {},    // è·Ÿè¸ªå…ˆå‰çš„å€¼ä»¥ä¾¿ç´¯åŠ 
        hasLostFocus: {},      // è·Ÿè¸ªå“ªäº›å­—æ®µå¤±å»äº†ç„¦é»
        currentInput: null,    // è·Ÿè¸ªç•¶å‰ç„¦é»çš„è¼¸å…¥æ¡†
        windowBlurred: false,  // è·Ÿè¸ªçª—å£æ˜¯å¦å¤±å»ç„¦é»
        
        expressionParser: {
            evaluate(expr) {
                // ç©ºè¼¸å…¥è™•ç†
                if (expr === undefined || expr === null) return '';
                const trimmed = String(expr).trim();
                if (trimmed === '') return '';
                
                // å¦‚æœè¼¸å…¥å°±æ˜¯å–®å€‹0ï¼Œæ‡‰è©²ä¿ç•™å®ƒ
                if (trimmed === '0') return '0';
                
                try {
                    // è§£æè¡¨é”å¼ä¸­çš„æ•¸å­—å’Œé‹ç®—ç¬¦
                    const tokens = (trimmed.match(/(\d+|\+|\-|\*|\/|\(|\))/g) || []).map(t => 
                        /\d+/.test(t) ? parseInt(t) : t
                    );
                    
                    if (tokens.length === 0) return '';
                    
                    // è¨ˆç®—è¡¨é”å¼çš„å€¼
                    const stack = [];
                    let num = 0, op = '+';
                    for (let token of tokens) {
                        if (typeof token === 'number') {
                            num = token;
                            if (op === '+') stack.push(num);
                            else if (op === '-') stack.push(-num);
                            else if (op === '*') stack.push(stack.pop() * num);
                            else if (op === '/') stack.push(Math.floor(stack.pop() / num));
                        } else {
                            op = token;
                        }
                    }
                    
                    const result = Math.max(0, Math.round(stack.reduce((a, b) => a + b, 0)));
                    // æ˜ç¢ºçš„é›¶å’Œè¨ˆç®—çµæœç‚ºé›¶çš„è™•ç†ä¸åŒ
                    if (result === 0 && trimmed !== '0') {
                        return '';
                    }
                    return String(result);
                } catch (e) {
                    console.error("Expression parsing error:", e);
                    return '';
                }
            }
        },

        // è™•ç†è¼¸å…¥æäº¤
        commitInput(input) {
            if (!input) return;
            
            // ä¿å­˜åŸå§‹è¼¸å…¥å€¼
            const originalValue = String(input.value);
            
            // è¨ˆç®—è¡¨é”å¼ä¸¦ç²å–çµæœ
            const newValue = this.expressionParser.evaluate(originalValue);
            
            // å¦‚æœå€¼ç™¼ç”Ÿè®ŠåŒ–ï¼Œæ›´æ–°è¼¸å…¥æ¡†
            if (originalValue !== newValue) {
                input.value = newValue;
            }
            
            // è™•ç†ç´¯åŠ é‚è¼¯
            const previousValue = this.previousValues[input.name] || 0;
            if (previousValue > 0 && (newValue === '0' || newValue !== '')) {
                const parsedNewValue = parseFloat(newValue) || 0;
                const sum = parsedNewValue + previousValue;
                
                // æ›´æ–°è¼¸å…¥æ¡†é¡¯ç¤º
                if (sum === 0 && originalValue !== '0') {
                    input.value = '';
                } else {
                    input.value = String(sum);
                }
                
                // é‡ç½®ç´¯åŠ å€¼
                this.previousValues[input.name] = 0;
            }
            
            // è¨ˆç®—ä¸¦æ›´æ–°é¡¯ç¤ºçµæœ
            calculateResult();
        },

        init() {
            // ç‚ºæ¯å€‹è¼¸å…¥æ¡†è¨­ç½®äº‹ä»¶è™•ç†
            this.inputs.forEach((input, index) => {
                // è·³éåŒ¯ç‡è¼¸å…¥æ¡†
                if (input.id === 'cost-note-input') return;
                
                // åˆå§‹åŒ–ç‹€æ…‹è¿½è¸ª
                this.previousValues[input.name] = 0;
                this.hasLostFocus[input.name] = false;
                
                // ç•¶è¼¸å…¥æ¡†ç²å¾—ç„¦é»æ™‚
                input.addEventListener('focus', () => {
                    this.currentInput = input;
                    
                    // å¦‚æœæ˜¯çª—å£é‡æ–°ç²å¾—ç„¦é»ï¼Œä¸è¦æ¸…ç©ºè¼¸å…¥
                    if (this.windowBlurred) {
                        this.windowBlurred = false;
                        return;
                    }
                    
                    // å¦‚æœä¹‹å‰å¤±å»ç„¦é»ä¸”æœ‰å€¼ï¼Œå‰‡æº–å‚™ç´¯åŠ 
                    const currentValue = input.value;
                    if (this.hasLostFocus[input.name] && currentValue !== '') {
                        // ä¿å­˜ç•¶å‰å€¼ç”¨æ–¼ä¹‹å¾Œç´¯åŠ 
                        this.previousValues[input.name] = parseFloat(currentValue) || 0;
                        // æ¸…ç©ºè¼¸å…¥æ¡†
                        input.value = '';
                        // é‡ç½®ç„¦é»æ¨™è¨˜
                        this.hasLostFocus[input.name] = false;
                    }
                });
                
                // ç•¶è¼¸å…¥æ¡†å¤±å»ç„¦é»æ™‚
                input.addEventListener('blur', () => {
                    this.commitInput(input);
                    this.hasLostFocus[input.name] = true;
                    this.currentInput = null;
                });
                
                // é»æ“Šè™•ç† - è¨ˆç®—è¡¨é”å¼ä¸¦è¨­ç½®å…‰æ¨™ä½ç½®
                input.addEventListener('click', (e) => {
                    if (input.value) {
                        const originalValue = input.value;
                        const newValue = this.expressionParser.evaluate(originalValue);
                        
                        if (originalValue !== newValue) {
                            input.value = newValue;
                            calculateResult();
                        }
                    }
                    
                    // å»¶é²åŸ·è¡Œï¼Œç¢ºä¿åœ¨ç€è¦½å™¨è™•ç†å®Œé»˜èªé»æ“Šè¡Œç‚ºå¾ŒåŸ·è¡Œ
                    setTimeout(() => {
                        // å°‡å…‰æ¨™å®šä½åˆ°æœ€å¾Œ
                        input.selectionStart = input.selectionEnd = input.value.length;
                    }, 0);
                });
                
                // æŒ‰éµè™•ç†
                input.addEventListener('keydown', (e) => {
                    // Deleteéµè™•ç†
                    if (e.key === 'Delete') {
                        input.value = '';
                        this.previousValues[input.name] = 0;
                        this.hasLostFocus[input.name] = false;
                        calculateResult();
                        return;
                    }
                    
                    // Enteréµè™•ç†
                    if (e.key === 'Enter') {
                        // æäº¤ç•¶å‰è¼¸å…¥
                        this.commitInput(input);
                        
                        // ç§»å‹•åˆ°ä¸‹ä¸€å€‹è¼¸å…¥æ¡†
                        const nextInput = this.inputs[(index + 1) % this.inputs.length];
                        nextInput.focus();
                        
                        // å»¶é²è¨­ç½®å…‰æ¨™ä½ç½®
                        setTimeout(() => {
                            nextInput.selectionStart = nextInput.selectionEnd = nextInput.value.length;
                        }, 0);
                    }
                });
            });
            
            // çª—å£å¤±å»ç„¦é»æ™‚
            window.addEventListener('blur', () => {
                this.windowBlurred = true;
                
                // æäº¤ç•¶å‰è¼¸å…¥æ¡†çš„å€¼
                if (this.currentInput && !this.currentInput.id.includes('cost-note')) {
                    this.commitInput(this.currentInput);
                }
            });
            
            // çª—å£é‡æ–°ç²å¾—ç„¦é»æ™‚
            window.addEventListener('focus', () => {
                this.windowBlurred = false;
            });
            
            // åŒ¯ç‡è¼¸å…¥æ¡†ç‰¹æ®Šè™•ç†
            const exchangeRateInput = document.getElementById('cost-note-input');
            if (exchangeRateInput) {
                exchangeRateInput.addEventListener('input', () => {
                    resultManager.updateExchangeRate();
                });
                
                exchangeRateInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Delete') {
                        exchangeRateInput.value = '';
                        resultManager.updateExchangeRate();
                        return;
                    }
                    
                    if (e.key === 'Enter') {
                        resultManager.updateExchangeRate();
                    }
                });
                
                exchangeRateInput.addEventListener('blur', () => {
                    resultManager.updateExchangeRate();
                });
                
                exchangeRateInput.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    setTimeout(() => {
                        exchangeRateInput.selectionStart = exchangeRateInput.selectionEnd = exchangeRateInput.value.length;
                    }, 0);
                });
            }
        }
    };

    const resultManager = {
        limits: {
            ubereats_bag: 50, ubereats_6grid: 15, ubereats_8grid: 13,
            foodpanda_bag: 80, foodpanda_6grid: 15, foodpanda_8grid: 13,
            foodpanda_2022_6grid: 15, foodpanda_2022_8grid: 13,
            foodpanda_velcro_insulated: 10, foodpanda_magnetic_insulated: 10,
            foodpanda_flip_insulated: 6
        },
        unitPrices: {
            ubereats_bag: 10,
            foodpanda_bag: 13,
            ubereats_6grid: 65,
            ubereats_8grid: 70,
            foodpanda_6grid: 65,
            foodpanda_8grid: 70,
            foodpanda_2022_6grid: 65,
            foodpanda_2022_8grid: 70,
            foodpanda_velcro_insulated: 135,
            foodpanda_magnetic_insulated: 135,
            foodpanda_flip_insulated: 170
        },
        hudDisplay: document.getElementById('hud-display'),
        costDisplay: document.getElementById('cost-display'),
        costSummary: document.getElementById('cost-summary'),
        currentTotalCost: 0,

        update() {
            const formattedDate = `${dateManager.state.year}/${utils.padZero(dateManager.state.month)}/${utils.padZero(dateManager.state.day)}è¨‚å–®`;
            
            // æ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„é …ç›®ï¼ˆæ•¸é‡>0ï¼‰
            const allItems = [];
            let totalCost = 0;
            
            // è™•ç†æ‰€æœ‰è¼¸å…¥æ¡†æ•¸æ“š
            inputManager.inputs.forEach(input => {
                // ç•¥éåŒ¯ç‡è¼¸å…¥æ¡†
                if (input.id === 'cost-note-input') return;
                
                // è·³éç©ºå€¼
                if (input.value === '') return;
                
                // è§£ææ•¸å€¼
                const value = parseFloat(input.value) || 0;
                if (value <= 0) return;
                
                // è¨ˆç®—ç®±æ•¸
                const boxes = this.calculateBoxes(value, this.limits[input.name]);
                // ç²å–æ¨™ç±¤åç¨±
                const label = input.parentElement.querySelector('.label').textContent.trim();
                
                // è¨ˆç®—æˆæœ¬
                const unitPrice = this.unitPrices[input.name] || 0;
                const cost = value * unitPrice;
                
                // æ·»åŠ åˆ°åˆ—è¡¨
                allItems.push({
                    label,
                    count: value,
                    boxes,
                    cost,
                    unitPrice
                });
                
                // ç´¯åŠ ç¸½æˆæœ¬
                totalCost += cost;
            });
            
            // æ›´æ–°ç•¶å‰ç¸½æˆæœ¬
            this.currentTotalCost = totalCost;
            
            // æ›´æ–°æ¡è³¼è¨ˆç®—é¡¯ç¤º - åªé¡¯ç¤ºæ—¥æœŸå’Œç®±æ•¸ï¼Œä¸é¡¯ç¤ºç¸½æˆæœ¬
            let boxesHTML = `<p>${formattedDate}</p>`;
            
            // ç›´æ¥æ·»åŠ æ‰€æœ‰é …ç›®ï¼ˆä¸åˆ†é¡ï¼‰
            allItems.forEach(item => {
                boxesHTML += `<p>${item.label} Ã—${item.boxes}</p>`;
            });
            
            this.hudDisplay.innerHTML = boxesHTML;
            
            // æ›´æ–°æ¡è³¼æˆæœ¬é¡¯ç¤º
            this.updateCostDisplay(allItems, totalCost, formattedDate);
            
            // æ›´æ–°åŒ¯ç‡è¨ˆç®—
            this.updateExchangeRate();
        },

        calculateBoxes(quantity, limit) {
            return quantity > 0 ? Math.ceil(quantity / limit) : 0;
        },
        
        // æ›´æ–°æ¡è³¼æˆæœ¬é¡¯ç¤º - é¡¯ç¤ºæ¯å€‹é …ç›®çš„æˆæœ¬ï¼ŒåŒ…å«æ•¸é‡
        updateCostDisplay(items, totalCost, date) {
            let costHTML = `<p>${date}</p>`;
            
            // éæ¿¾å‡ºæœ‰æˆæœ¬çš„é …ç›®
            const costItems = items.filter(item => item.cost > 0);
            
            if (costItems.length > 0) {
                costItems.forEach(item => {
                    costHTML += `<p>${item.label} * ${item.count} = ${utils.formatNumber(item.cost)} å…ƒ</p>`;
                });
                
                this.costDisplay.innerHTML = costHTML;
                
                // æ›´æ–°ç¸½æˆæœ¬é‡‘é¡ (æ‡‰ç”¨åŒ¯ç‡è¨ˆç®—)
                this.updateExchangeRate();
                
                // é¡¯ç¤ºç¸½æˆæœ¬å€åŸŸ
                this.costSummary.style.display = 'block';
            } else {
                costHTML += "<p>å°šç„¡æˆæœ¬è³‡æ–™</p>";
                this.costDisplay.innerHTML = costHTML;
                
                // éš±è—ç¸½æˆæœ¬å€åŸŸ
                this.costSummary.style.display = 'none';
            }
        },
        
        // æ›´æ–°åŒ¯ç‡è¨ˆç®—
        updateExchangeRate() {
            const exchangeRateInput = document.getElementById('cost-note-input');
            const totalCostElement = document.getElementById('total-cost-amount');
            
            if (exchangeRateInput && totalCostElement) {
                const exchangeRate = parseFloat(exchangeRateInput.value);
                
                if (exchangeRate && !isNaN(exchangeRate) && this.currentTotalCost > 0) {
                    // è¨ˆç®—åŒ¯ç‡å¾Œçš„æˆæœ¬
                    const exchangedCost = this.currentTotalCost * exchangeRate;
                    
                    // æ›´æ–°ç¸½æˆæœ¬é¡¯ç¤º
                    totalCostElement.textContent = utils.formatNumber(exchangedCost);
                } else {
                    // é¡¯ç¤ºåŸå§‹ç¸½æˆæœ¬
                    totalCostElement.textContent = utils.formatNumber(this.currentTotalCost);
                }
            }
        },

        // æ¡è³¼è¨ˆç®—å€åŸŸè¤‡è£½åŠŸèƒ½
        copyBoxes() {
            const text = Array.from(this.hudDisplay.querySelectorAll('p'))
                .map(p => p.textContent)
                .join('\n');
            navigator.clipboard.writeText(text)
                .then(() => alert('è¤‡è£½æˆåŠŸ'))
                .catch(() => alert('è¤‡è£½å¤±æ•—'));
        },

        init() {
            // åªæœ‰æ¡è³¼è¨ˆç®—å€åŸŸå¯ä»¥è¤‡è£½
            this.hudDisplay.addEventListener('click', () => this.copyBoxes());
            
            this.update();
        }
    };

    function calculateResult() {
        resultManager.update();
    }

    dateManager.init();
    inputManager.init();
    resultManager.init();
</script>
